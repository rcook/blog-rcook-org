<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Setting up Rails</title>
  <link rel="stylesheet" href="default.css">
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="default.js"></script>
</head>
<div id="nav">
<ul>
  <li><a href="index.html">Contents</a></li>
</ul>
</div>
<h1>Setting up Rails (based on <a href="http://www.web-l.nl/posts/5-setting-up-a-rails-production-server-part-1">these</a> instructions)</h1>
<body>
<h2>Initial setup</h2>
<h3>Obtain IP address of virtual machine and use this to create Windows host entry</h3>
<div class="code-block">
ifconfig
</div>
<h3>Ensure local package repository and packages are up to date</h3>
<div class="code-block">
sudo apt-get update
sudo apt-get upgrade
</div>
<h3>Install Apache and MySQL</h3>
<div class="code-block">
sudo apt-get install git build-essential zlibc zlib1g-dev zlib1g
sudo apt-get install apache2 apache2-prefork-dev libapr1-dev libaprutil1-dev
sudo apt-get install curl libcurl4-openssl-dev libssl-dev libopenssl-ruby
sudo apt-get install libreadline6 libreadline6-dev
sudo apt-get install mysql-server mysql-client
</div>
<h2>Setting up RVM/Ruby/Rails</h2>
<h3>Install prerequisites</h3>
<div class="code-block">
sudo apt-get install bash patch bzip2 git-core
sudo apt-get install openssl
sudo apt-get install libyaml-dev libsqlite3-dev sqlite3 libxml2-dev libxslt-dev
sudo apt-get install autoconf libc6-dev libgdbm-dev ncurses-dev automake libtool bison subversion
sudo apt-get install pkg-config libffi-dev nodejs
</div>
<h3>Install RVM</h3>
<div class="code-block">
sudo bash -s stable &lt; &lt;(curl -s https://raw.github.com/wayneeseguin/rvm/master/binscripts/rvm-installer)
</div>
<h3>Set up users and groups</h3>
<div class="code-block">
sudo adduser deploy
sudo adduser deploy rvm
sudo adduser <em>&lt;your-user-name&gt;</em> deploy
sudo adduser <em>&lt;your-user-name&gt;</em> rvm
sudo chown -R deploy:deploy /var/www
sudo chmod g+w /var/www
</div>
<h3>Log out and in again and then install Ruby and other bits</h3>
<div class="code-block">
rvm install 2.0.0
rvm --default use 2.0.0
gem install bundler
</div>
<h3>Create a development database for the Rails app</h3>
<div class="code-block">
mysql -u root -p
</div>
And enter the following into the MySQL shell:
<div class="code-block">
CREATE DATABASE ahanalytics_development;
GRANT ALL PRIVILEGES ON ahanalytics_development.* TO ahanalytics@localhost IDENTIFIED BY 'ahanalytics';
FLUSH PRIVILEGES;
</div>
<h3>Deploy a new Rails app</h3>
<div class="code-block">
rvm use 2.0.0-p0@ahanalytics --create
rvm --default use 2.0.0-p0@ahanalytics
gem install rails --version 3.2.13
cd /var/www/
rails new ahanalytics -d mysql
cd ahanalytics/
#UNTESTED# rails generate scaffold todo name:string finished:boolean
#UNTESTED# echo "gem 'therubyracer'" &gt;&gt; Gemfile
#UNTESTED# bundle install
</div>
<h3>Fix up database configuration in <span class="code-inline">database.yml</span></h3>
Add log-in info created for database into configuration file.
<h2>Setting up Passenger</h2>
<h3>Install prerequisites</h3>
<div class="code-block">
sudo apt-get install libcurl4-openssl-dev
sudo apt-get install apache2-prefork-dev
sudo apt-get install libapr1-dev
sudo apt-get install libaprutil1-dev
</div>
<h3>Install Passenger using <a href="https://github.com/FooBarWidget/passenger/pull/71">these</a> instructions</h3>
<div class="code-block">
git clone https://github.com/FooBarWidget/passenger.git
cd passenger/
gem build passenger.gemspec
gem install passenger-4.0.0.rc5.gem
cd ..
rm -rf passenger/
rvmsudo passenger-install-apache2-module
</div>
<h3>Create file <span class="path">/etc/apache2/mods-available/passenger.load</span> with following content:</h3>
<div class="content">
LoadModule passenger_module /usr/local/rvm/gems/ruby-2.0.0-p0/gems/passenger-4.0.0.rc5/libout/apache2/mod_passenger.so
</div>
<h3>Create file <span class="path">/etc/apache2/mods-available/passenger.conf</span> with following content:</h3>
<div class="content">
PassengerRoot /usr/local/rvm/gems/ruby-2.0.0-p0/gems/passenger-4.0.0.rc5
PassengerRuby /usr/local/rvm/wrappers/ruby-2.0.0-p0/ruby
</div>
<h3>Modify <span class="path">/etc/apache2/apache2.conf</span> by adding following to end</h3>
<div class="content">
ServerName localhost
</div>
<h3>Activate Passenger and restart Apache</h3>
<div class="code-block">
sudo a2enmod passenger
sudo service apache2 restart
</div>
<h3>Move the default page and update <span class="path">/etc/apache2/sites-available/default</span> using <a href="http://www.web-l.nl/posts/5-setting-up-a-rails-production-server-part-1">these</a> instructions</h3>
<div class="code-block">
mkdir /var/www/default
mv /var/www/index.html /var/www/default/index.html
</div>
<h2>Fix <span class="code-inline">deploy</span>'s access to web</h2>
<div class="code-block">
sudo chown -R deploy:deploy /var/www
</div>
<h2>Deployment of app</h2>
<h3>Log in as deploy and simulate deployment/migration</h3>
<div class="code-block">
cd /var/www/ahanalytics/
rvm use 2.0.0-p0 --default
bundle install --deployment --without development test
bundle exec rake db:migrate RAILS_ENV=production
bundle exec rake assets:precompile
touch /var/www/ahanalytics/tmp/restart.txt
</div>
<h3>Log back in as regular user and configure virtual host <span class="path">/etc/apache2/sites-available/ahanalytics</span></h3>
<div class="content">
&lt;VirtualHost _default_:80&gt;
  # ServerName www.example.com # Commented out for default
  DocumentRoot /var/www/ahanalytics/public/
  &lt;Directory /var/www/ahanalytics/public/&gt;
    AllowOverride all
    Options -MultiViews
  &lt;/Directory&gt;
&lt;/VirtualHost&gt;
</div>
<h3>Enable Rails app</h3>
<div class="code-block">
sudo a2ensite ahanalytics
sudo service apache2 reload
sudo a2dissite default
</div>
</body>
</html>
